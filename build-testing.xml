<project basedir="." default="test-all" name="BEAST 2 Unit Tests"
	xmlns:fx="javafx:com.sun.javafx.tools.ant">
    <description>
        Simplified build script for running unit tests only.
        Not for producing releases.
    </description>

    <!-- set global properties for this build -->
    <property name="src" location="src" />
    <property name="build" location="build" />
    <property name="lib" location="lib" />
    <property name="doc" location="doc" />
    <property name="dist" location="build/dist" />
    <property name="test" location="test" />

    <property name="main_class_BEASTLauncher" value="beast.app.beastapp.BeastLauncher" />
    <property name="report" value="build/junitreport" />

    <path id="classpath">
        <fileset dir="${lib}" includes="beagle.jar"/>
        <fileset dir="${lib}" includes="jam.jar"/>
        <fileset dir="${lib}" includes="colt.jar"/>
        <fileset dir="${lib}" includes="fest.jar"/>
        <fileset dir="${lib}" includes="junit-4.8.2.jar"/>
        <fileset dir="${lib}" includes="antlr-runtime-4.9.2.jar"/>
        <fileset dir="${lib}" includes="commons-math3-3.6.1.jar" />
    </path>

    <target name="init">
        <echo message="${ant.project.name}: ${ant.file}" />
    </target>

    <target name="clean">
        <delete dir="${build}" />
        <delete dir="${test}" />
    </target>

    <!-- compile Java source code -->
    <!-- compile Java source code -->
    <target name="compile-all" depends="init,beast.pkgmgmt,beast.base,beast.app,test.beast">
        <echo>Building BEAST 2</echo>
        <!--
        <mkdir dir="${build}" />

        <javac source="1.8"
		target="1.8"
		bootclasspath='/opt/jdk1.8.0_131/jre/lib/rt.jar'
               srcdir="${src}"
               destdir="${build}"
               classpathref="classpath"
               fork="true"
               memoryinitialsize="256m"
               memorymaximumsize="1024m"
               includeAntRuntime='false'>
            <include name="beast/**/**" />
            <include name="org/**/**" />
            <include name="test/beast/**" />
        </javac>

        <echo message="Ant running on Java version ${ant.java.version}"/>

        <delete file="${build}/beast/app/beauti/BeautiLauncher.class" />
        <delete file="${build}/beast/app/tools/AppLauncherLauncher.class" />
        <delete file="${build}/beast/app/tools/LogCombinerLauncher.class" />
        <delete file="${build}/beast/app/treeannotator/TreeAnnotatorLauncher.class" />
        <delete file="${build}/beast/app/util/Utils6.class" />
        <delete file="${build}/beast/app/BEASTVersion.class" />
        <delete file="${build}/beast/util/BEASTClassLoader.class" />
    	
        <delete file="${build}/beast/app/util/Version.class" />
        <javac source="1.6"
               target="1.6"
               bootclasspath='/opt/jdk1.6.0_45/jre/lib/rt.jar'
               srcdir="${src}"
               destdir="${build}"
               classpathref="classpath"
               fork="true"
               memoryinitialsize="256m"
               memorymaximumsize="1024m"
               includeAntRuntime='false'>
            <include name="beast/**/*Launcher.java" />
            <include name="beast/**/Utils6.java" />
            <include name="beast/**/BEASTVersion.java" />
            <include name="beast/**/Version.java" />
            <include name="beast/util/Package*.java" />
            <include name="beast/app/util/Arguments.java" />
            <include name="beast/core/util/Log.java" />
	    <include name="beast/util/BEASTClassLoader.java" />
        </javac>
        <copy todir="${build}">
            <fileset dir="${src}" includes="**/*.properties" />
            <fileset dir="${src}" includes="**/*.png" />
        </copy>
        -->
        <echo message="Successfully compiled." />
    </target>

    <target name="beast.pkgmgmt" depends="init">
        <mkdir dir="${build}" />
    	<javac 
               srcdir="beast.pkgmgmt/src"
               destdir="build"
               classpathref="classpath"
               fork="true"
               memoryinitialsize="256m"
               memorymaximumsize="1024m"
               includeAntRuntime='false'>
            <include name="beast/**/**" />
        </javac>
                
        <jar jarfile="build/dist/launcher.jar">
            <manifest>
                <attribute name="Built-By" value="${user.name}" />
            </manifest>

            	
            <fileset dir="${build}">
                <include name="beast/pkgmgmt/**/*.class" />
                <include name="beast/pkgmgmt/**/*.properties" />
                <include name="beast/pkgmgmt/**/*.png" />
            </fileset>
        </jar>
    </target>


    <target name="beast.base" depends="init">
    	<javac 
               srcdir="beast.base/src"
               destdir="build"
               classpathref="classpath"
               fork="true"
               memoryinitialsize="256m"
               memorymaximumsize="1024m"
               includeAntRuntime='false'>
            <include name="beast/**/**" />
            <include name="org/**/**" />
        </javac>
                
        <jar jarfile="build/dist/beast.base.jar">
            <manifest>
                <attribute name="Built-By" value="${user.name}" />
            </manifest>

            <!-- data types -->
            <service type="beast.base.evolution.datatype.DataType">
				<provider classname="beast.base.evolution.datatype.Aminoacid"/>
				<provider classname="beast.base.evolution.datatype.Nucleotide"/>
				<provider classname="beast.base.evolution.datatype.TwoStateCovarion"/>
				<provider classname="beast.base.evolution.datatype.Binary"/>
				<provider classname="beast.base.evolution.datatype.IntegerData"/>
				<provider classname="beast.base.evolution.datatype.StandardData"/>
				<provider classname="beast.base.evolution.datatype.UserDataType"/>
            </service>
                
            <!-- Model logger service: for breaking dependency between beast.base.inference and beast.base.parser -->
            <service type="beast.base.inference.util.ModelLogger"
            	provider="beast.base.parser.XMLModelLogger"/>
            	
            <fileset dir="${build}">
                <include name="org/**/*.class" />
                <include name="beast/base/**/*.class" />
                <include name="beast/base/**/*.properties" />
                <include name="beast/base/**/*.png" />
            </fileset>
            <zipgroupfileset dir="${lib}" includes="jam.jar" />
            <zipgroupfileset dir="${lib}" includes="beagle.jar" />
            <zipgroupfileset dir="${lib}" includes="colt.jar" />
            <zipgroupfileset dir="${lib}" includes="antlr-runtime-4.9.2.jar"/>
	        <zipgroupfileset dir="${lib}" includes="commons-math3-3.6.1.jar" />
        </jar>
    </target>


    <target name="beast.app" depends="init">
    	<javac 
               srcdir="beast.app/src"
               destdir="build"
               classpathref="classpath"
               fork="true"
               memoryinitialsize="256m"
               memorymaximumsize="1024m"
               includeAntRuntime='false'>
            <include name="beast/**/**" />
        </javac>
                
        <jar jarfile="build/dist/beast.app.jar">
            <manifest>
                <attribute name="Built-By" value="${user.name}" />
            </manifest>

			<service type="beast.app.inputeditor.InputEditor">
				<provider classname="beast.app.inputeditor.AlignmentListInputEditor"/>
				<provider classname="beast.app.inputeditor.BEASTObjectInputEditor"/>
				<provider classname="beast.app.inputeditor.BooleanInputEditor"/>
				<provider classname="beast.app.inputeditor.DoubleInputEditor"/>
				<provider classname="beast.app.inputeditor.DoubleListInputEditor"/>
				<provider classname="beast.app.inputeditor.EnumInputEditor"/>
				<provider classname="beast.app.inputeditor.FileInputEditor"/>
				<provider classname="beast.app.inputeditor.FileListInputEditor"/>
				<provider classname="beast.app.inputeditor.IntegerInputEditor"/>
				<provider classname="beast.app.inputeditor.IntegerListInputEditor"/>
				<provider classname="beast.app.inputeditor.ListInputEditor"/>
				<provider classname="beast.app.inputeditor.LogFileInputEditor"/>
				<provider classname="beast.app.inputeditor.LogFileListInputEditor"/>
				<provider classname="beast.app.inputeditor.LoggerListInputEditor"/>
				<provider classname="beast.app.inputeditor.LongInputEditor"/>
				<provider classname="beast.app.inputeditor.MRCAPriorInputEditor"/>
				<provider classname="beast.app.inputeditor.OutFileInputEditor"/>
				<provider classname="beast.app.inputeditor.OutFileListInputEditor"/>
				<provider classname="beast.app.inputeditor.ParameterInputEditor"/>
				<provider classname="beast.app.inputeditor.ParametricDistributionInputEditor"/>
				<provider classname="beast.app.inputeditor.SiteModelInputEditor"/>
				<provider classname="beast.app.inputeditor.StringInputEditor"/>
				<provider classname="beast.app.inputeditor.TaxonSetInputEditor"/>
				<provider classname="beast.app.inputeditor.TaxonSetListInputEditor"/>
				<provider classname="beast.app.inputeditor.TipDatesInputEditor"/>
				<provider classname="beast.app.inputeditor.TreeFileInputEditor"/>
				<provider classname="beast.app.inputeditor.TreeFileListInputEditor"/>
				<provider classname="beast.app.inputeditor.XMLFileInputEditor"/>
				<provider classname="beast.app.inputeditor.XMLFileListInputEditor"/>
				<provider classname="beast.app.beauti.ClockModelListInputEditor"/>
				<provider classname="beast.app.beauti.ConstantPopulationInputEditor"/>
				<provider classname="beast.app.beauti.FrequenciesInputEditor"/>
				<provider classname="beast.app.beauti.GeneTreeForSpeciesTreeDistributionInputEditor"/>
				<provider classname="beast.app.beauti.OperatorListInputEditor"/>
				<provider classname="beast.app.beauti.PriorInputEditor"/>
				<provider classname="beast.app.beauti.PriorListInputEditor"/>
				<provider classname="beast.app.beauti.SpeciesTreePriorInputEditor"/>
				<provider classname="beast.app.beauti.StateNodeInitialiserListInputEditor"/>
				<provider classname="beast.app.beauti.StateNodeListInputEditor"/>
				<provider classname="beast.app.beauti.TreeDistributionInputEditor"/>
			</service>
	
			<!-- AlignmentImporter declares classes for parsing different alignment formats -->
			<service type="beast.app.inputeditor.AlignmentImporter">
				<provider classname="beast.app.inputeditor.NexusImporter"/>
				<provider classname="beast.app.inputeditor.FastaImporter"/>
				<provider classname="beast.app.inputeditor.XMLImporter"/>
			</service>
	
			<!--
			<service type="beast.app.beauti.BeautiHelpAction">		</service>
			-->
			
			<!--			
			PriorProvider is for providing extra priors in the prior panel of BEAUti
			like MultiMonophyleticConstrains
			-->
			<service type="beast.app.beauti.PriorProvider">
				<provider classname="beast.app.beauti.MRCAPriorProvider"/>
			</service>
            	
            <fileset dir="${build}">
                <include name="beast/app/**/*.class" />
                <include name="beast/app/**/*.properties" />
                <include name="beast/app/**/*.png" />
            </fileset>
        </jar>
    </target>
    
    <target name="test.beast" depends="init">
    	<javac 
               srcdir="beast.app/test"
               destdir="build"
               fork="true"
               memoryinitialsize="256m"
               memorymaximumsize="1024m"
               includeAntRuntime='false'>
               
               <classpath>
                <path id="assertj-without-test-beast.classpath">
			        <fileset dir="${lib}" includes="junit-4.8.2.jar"/>
        			<fileset dir="${lib}" includes="beagle.jar"/>
			        <fileset dir="${lib}" includes="jam.jar"/>
			        <fileset dir="${lib}" includes="colt.jar"/>
			        <fileset dir="${lib}" includes="fest.jar"/>
			        <fileset dir="${lib}" includes="antlr-runtime-4.9.2.jar"/>
			        <fileset dir="build/dist" includes="beast.base.jar" />
			        <fileset dir="build/dist" includes="beast.app.jar" />
			        <fileset dir="build/dist" includes="beast.pkgmgmt.jar" />
			        <fileset dir="${lib}" includes="assertj-swing-junit-3.17.1.jar"/>
				    <fileset dir="${lib}" includes="assertj-core-3.20.2.jar"/>
				    <fileset dir="${lib}" includes="assertj-swing-3.17.1.jar"/>
                </path>
               </classpath>
            <include name="test/**/**" />
        </javac>
                
        <jar jarfile="build/dist/test.beast.jar">
            <manifest>
                <attribute name="Built-By" value="${user.name}" />
            </manifest>
            <fileset dir="${build}">
                <include name="test/beast/**/*.class" />
                <include name="test/beast/**/*.properties" />
                <include name="test/beast/**/*.png" />
            </fileset>
        </jar>
    </target>    
    
    

    
   <!-- JUnit test -->
    <target name="junit">
        <mkdir dir="${report}" />
        
        <junit printsummary="yes" failureproperty="junitfailed" fork="true" dir="/beast2">
            <classpath>
                <path id="classpath2">
			        <fileset dir="/beast2/${lib}" includes="junit-4.8.2.jar"/>
        			<fileset dir="/beast2/${lib}" includes="beagle.jar"/>
			        <fileset dir="/beast2/${lib}" includes="jam.jar"/>
			        <fileset dir="/beast2/${lib}" includes="colt.jar"/>
			        <fileset dir="/beast2/${lib}" includes="fest.jar"/>
			        <fileset dir="/beast2/${lib}" includes="antlr-runtime-4.9.2.jar"/>
			        <fileset dir="/beast2/build/dist" includes="beast.base.jar" />
			        <fileset dir="/beast2/build/dist" includes="beast.app.jar" />
			        <fileset dir="/beast2/build/dist" includes="launcher.jar" />
			        <fileset dir="/beast2/build/dist" includes="test.beast.jar" />
			    </path>		
			    
			    <!--	    
			    <path location="build/test.beast"/>
			    -->
            </classpath>
            <formatter type="xml" />

            <batchtest fork="yes" todir="${report}">
                <fileset dir="beast.app/test">
                    <include name="test/**/*Test.java" />
                    <exclude name="test/beast/beast2vs1/**/*Test.java"/>
                    <exclude name="test/beast/app/beauti/**/*Test.java"/>
                </fileset>
            </batchtest>
        </junit>
        <echo message="JUnit test finished." />
    </target>

    <target name="junitreport">
        <junitreport todir="${report}">
            <fileset dir="${report}" includes="*.xml" />
            <report format="frames" todir="${report}" />
        </junitreport>
        <echo message="JUnit test report finished." />
    </target>

    <!-- Target for Travis-CI with non-zero exit status on test failure. -->
    <target name="travis" depends="clean, compile-all, junit, junitb">
        <fail if="junitfailed" message="One or more CORE BEAST tests failed."/>
        <fail if="junitbfailed" message="One or more BEAUTI tests failed."/>
    </target>

    <!-- testing beauti gui-->
    <target name="junitb">
        <mkdir dir="${report}" />
        <junit printsummary="yes" failureproperty="junitbfailed" dir="/beast2/">
            <!--showoutput='yes'-->
            <classpath>
                <path id="assertj.classpath">
			        <fileset dir="/beast2/${lib}" includes="junit-4.8.2.jar"/>
        			<fileset dir="/beast2/${lib}" includes="beagle.jar"/>
			        <fileset dir="/beast2/${lib}" includes="jam.jar"/>
			        <fileset dir="/beast2/${lib}" includes="colt.jar"/>
			        <fileset dir="/beast2/${lib}" includes="fest.jar"/>
			        <fileset dir="/beast2/${lib}" includes="antlr-runtime-4.9.2.jar"/>
			        <fileset dir="/beast2/build/dist" includes="beast.base.jar" />
			        <fileset dir="/beast2/build/dist" includes="beast.app.jar" />
			        <fileset dir="/beast2/build/dist" includes="launcher.jar" />
			        <fileset dir="/beast2/build/dist" includes="test.beast.jar" />
			        <fileset dir="/beast2/${lib}" includes="assertj-swing-junit-3.17.1.jar"/>
				    <fileset dir="/beast2/${lib}" includes="assertj-core-3.20.2.jar"/>
				    <fileset dir="/beast2/${lib}" includes="assertj-swing-3.17.1.jar"/>
                </path>
                <!--
                <path location="${build}" />
                -->
            </classpath>

            <formatter type="xml" />

            <batchtest fork="yes" todir="${report}">
                <fileset dir="test.beast/src">
                    <include name="test/beast/app/beauti/**/*Test.java"/>
                </fileset>
            </batchtest>
        </junit>
        <echo message="JUnit test finished." />
    </target>
    

    <target name="create-symlinks">
        <mkdir dir="/beast2"/>
        <symlink link="/beast2/lib" resource="/lib"/>
        <symlink link="/beast2/test" resource="/test"/>
        <symlink link="/beast2/build" resource="/build"/>
        <symlink link="/beast2/examples" resource="/examples"/>
        <symlink link="/beast2/templates" resource="/templates"/>
        <symlink link="/beast2/beast.app" resource="/beast.app"/>
        <symlink link="/beast2/beast.base" resource="/beast.base"/>
        <symlink link="/beast2/beast.pkgmgmt" resource="/beast.pkgmgmt"/>
    </target>


    <!-- Target for CI testing with non-zero exit status on test failure. -->
    <target name="test-all" depends="clean, compile-all, create-symlinks, junit, junitb">
        <fail if="junitfailed" message="One or more CORE BEAST tests failed."/>
        <fail if="junitbfailed" message="One or more BEAUTI tests failed."/>
    </target>

    <target name="test-core" depends="clean, compile-all, create-symlinks, junit">
        <fail if="junitfailed" message="One or more CORE BEAST tests failed."/>
    </target>

    <target name="test-beauti" depends="clean, compile-all, create-symlinks, junitb">
        <fail if="junitbfailed" message="One or more BEAUTI tests failed."/>
    </target>


  </project>
